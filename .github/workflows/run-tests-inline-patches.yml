name: Run tests with inline patches

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: "Commit SHA to checkout"
        required: true
        type: string

      test_patch_b64:
        description: "Base64-encoded *test* patch (git apply format)"
        required: true
        type: string

      golden_patch_b64:
        description: "Base64-encoded *golden* patch (git apply format)"
        required: true
        type: string

      base_patch_b64:
        description: "Base64-encoded *base* patch (optional; git apply format)"
        required: false
        default: ""
        type: string

      test_cmd:
        description: "Test command to run"
        required: true
        type: string

jobs:
  test:
    name: "${{ matrix.run_name }}"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - run_name: "base(+?) + golden"
            apply_golden: true
            apply_test: false
          - run_name: "base(+?) + test"
            apply_golden: false
            apply_test: true
          - run_name: "base(+?) + golden + test"
            apply_golden: true
            apply_test: true

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout commit
        shell: bash
        run: |
          set -euo pipefail
          git checkout --force "${{ inputs.commit_sha }}"

      - name: Apply patches (base -> golden -> test)
        shell: bash
        env:
          BASE_PATCH_B64: ${{ inputs.base_patch_b64 }}
          GOLDEN_PATCH_B64: ${{ inputs.golden_patch_b64 }}
          TEST_PATCH_B64: ${{ inputs.test_patch_b64 }}
          APPLY_GOLDEN: ${{ matrix.apply_golden }}
          APPLY_TEST: ${{ matrix.apply_test }}
        run: |
          set -euo pipefail
          mkdir -p /tmp/patches

          decode_and_apply () {
            local name="$1"
            local b64="$2"

            if [[ -z "${b64}" ]]; then
              echo "Skipping ${name} (empty)"
              return 0
            fi

            local path="/tmp/patches/${name}.patch"
            printf '%s' "${b64}" | base64 -d > "${path}"
            echo "Applying ${name}: ${path}"
            git apply --whitespace=nowarn "${path}"
          }

          # Always apply base first (if provided)
          decode_and_apply "000_base" "${BASE_PATCH_B64}"

          # Conditionally apply golden/test in order
          if [[ "${APPLY_GOLDEN}" == "true" ]]; then
            decode_and_apply "010_golden" "${GOLDEN_PATCH_B64}"
          else
            echo "Skipping golden (matrix)"
          fi

          if [[ "${APPLY_TEST}" == "true" ]]; then
            decode_and_apply "020_test" "${TEST_PATCH_B64}"
          else
            echo "Skipping test (matrix)"
          fi

      - name: Run tests
        shell: bash
        run: |
          set -euo pipefail
          bash -lc "${{ inputs.test_cmd }}"
